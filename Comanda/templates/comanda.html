{% extends 'main.html'%}
{%block extra_css%}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

<style>
  .card {
      width: 18rem;
      height: 25rem;
      margin: 15px;
  }

  @media (max-width: 1400px) {
      .card {
          width: calc(95%);
      }
  }

  @media (max-width: 1200px) {
      .card {
          width: calc(90%); 
      }
  }

  @media (max-width: 992px) {
      .card {
          width: calc(90%);
      }
  }
  
</style>

{% endblock extra_css %}
{% block contenido %}

<h1> Seleccione la mesa y los productos: </h1>

<div id="mesasDisponibles">
    <div class="input-group" style="margin-top: 15px">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="text" id="search-input" name="search" class="form-control" placeholder="Buscar productos">
    </div>   
    <div id="productos-container" class="row">
        {% for producto in productos %}
            <div class="col-lg-4 col-md-6 col-sm-12">
                <div class="card card-item">
                    {% if producto.imagen %}
                        <img src="{{ producto.imagen.url }}" class="card-img-top" style="width: 100%; height:200px;" alt="...">
                    {% else %}
                        <div class="card-placeholder" style="width: 100%; height:200px; background-color: #eee; text-align: center; line-height: 200px;">
                            Sin imagen
                        </div>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ producto.nombre }}</h5>
                        <p class="card-text">Precio: ${{ producto.precio }} MXN</p>
                        <form method="post" action="{% url 'agregar_por_mesa' %}">
                            {% csrf_token %}
                            <input type="hidden" name="mesa_id" value="{{ mesas_seleccionadas.id }}">
                            <input type="hidden" name="id_producto_{{ mesas_seleccionadas.id }}" value="{{ producto.id }}">

                            <label>Sabores:</label>
                            {% for sabor in producto.sabores %}
                                <input class="form-check-input" type="checkbox" value="{{ sabor }}" name="sabores_{{ mesas_seleccionadas.id }}[]">
                                <label class="form-check-label">{{ sabor }}</label><br>
                            {% endfor %}

                            <input class="form-control" type="number" name="cantidad_{{ mesas_seleccionadas.id }}" style="width: 65px; height: 25px; position: absolute; bottom: 10px; right: 20px;" value="1" min="1">
                            <button type="submit" class="btn btn-primary">Agregar al Carrito <i class="bi bi-plus-circle-fill"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>


<a href="{% url 'Dashboard' %}" class="btn btn-danger" style="margin-top: 15px; margin-bottom: 15px;">Cancelar </a>


{% endblock contenido%}

{% block extra_js%}


<!-- ... (Código anterior) -->

<script>
    $(document).ready(function () {
        $('#search-input').on('input', function () {
            var query = $(this).val();

            $.ajax({
                url: '{% url "buscar_productos" %}',
                data: { 'q': query },
                dataType: 'json',
                success: function (data) {
                    // Limpia el contenedor de productos antes de mostrar los resultados de búsqueda
                    $('#productos-container').empty();

                    // Itera sobre los resultados y agrega cada producto al contenedor
                    $.each(data, function (index, producto) {
                        var cardHtml = '<div class="col-lg-4 col-md-6 col-sm-12">';
                        cardHtml += '<div class="card card-item">';

                        // Comprobación de la existencia de la imagen
                        if (producto.imagen) {
                            var img = new Image();
                            img.src = producto.imagen;

                            // Manejar la carga exitosa de la imagen
                            img.onload = function () {
                                cardHtml += '<img src="' + producto.imagen + '" class="card-img-top" style="width: 100%; height:200px;" alt="...">';
                                cardHtml += '<div class="card-body">';
                                cardHtml += '<h5 class="card-title">' + producto.nombre + '</h5>';
                                cardHtml += '<p class="card-text">Precio: $' + producto.precio + ' MXN</p>';
                                
                                // Comprobación y generación de checkboxes para los sabores
                                $.each(producto.sabores, function (index, sabor) {
                                    cardHtml += '<input class="form-check-input" type="checkbox" value="' + sabor + '" name="sabores">';
                                    cardHtml += '<label class="form-check-label">' + sabor + '</label><br>';
                                });

                                // Resto del código HTML
                                cardHtml += '<input class="form-control" type="number" name="cantidad" style="width: 65px; height: 25px; position: absolute; bottom: 10px; right: 20px;" value="1" min="1">';
                                cardHtml += '<input type="hidden" name="id_producto" value ="' + producto.id + '">';
                                cardHtml += '</div></div></div>';
                                
                                // Agrega el HTML del producto al contenedor
                                $('#productos-container').append(cardHtml);
                            };

                            // Manejar el caso en que la carga de la imagen falla
                            img.onerror = function () {
                                cardHtml += '<div class="card-placeholder" style="width: 100%; height:200px; background-color: #eee; text-align: center; line-height: 200px;">Sin imagen</div>';
                                cardHtml += '<div class="card-body">';
                                cardHtml += '<h5 class="card-title">' + producto.nombre + '</h5>';
                                cardHtml += '<p class="card-text">Precio: $' + producto.precio + ' MXN</p>';
                                
                                // Comprobación y generación de checkboxes para los sabores
                                $.each(producto.sabores, function (index, sabor) {
                                    cardHtml += '<input class="form-check-input" type="checkbox" value="' + sabor + '" name="sabores">';
                                    cardHtml += '<label class="form-check-label">' + sabor + '</label><br>';
                                });

                                // Resto del código HTML
                                cardHtml += '<input class="form-control" type="number" name="cantidad" style="width: 65px; height: 25px; position: absolute; bottom: 10px; right: 20px;" value="1" min="1">';
                                cardHtml += '<input type="hidden" name="id_producto" value ="' + producto.id + '">';
                                cardHtml += '</div></div></div>';
                                
                                // Agrega el HTML del producto al contenedor
                                $('#productos-container').append(cardHtml);
                            };
                        } else {
                            cardHtml += '<div class="card-placeholder" style="width: 100%; height:200px; background-color: #eee; text-align: center; line-height: 200px;">Sin imagen</div>';
                            cardHtml += '<div class="card-body">';
                            cardHtml += '<h5 class="card-title">' + producto.nombre + '</h5>';
                            cardHtml += '<p class="card-text">Precio: $' + producto.precio + ' MXN</p>';
                            
                            // Comprobación y generación de checkboxes para los sabores
                            $.each(producto.sabores, function (index, sabor) {
                                cardHtml += '<input class="form-check-input" type="checkbox" value="' + sabor + '" name="sabores">';
                                cardHtml += '<label class="form-check-label">' + sabor + '</label><br>';
                            });

                            // Resto del código HTML
                            cardHtml += '<input class="form-control" type="number" name="cantidad" style="width: 65px; height: 25px; position: absolute; bottom: 10px; right: 20px;" value="1" min="1">';
                            cardHtml += '<input type="hidden" name="id_producto" value ="' + producto.id + '">';
                            cardHtml += '</div></div></div>';
                            
                            // Agrega el HTML del producto al contenedor
                            $('#productos-container').append(cardHtml);
                        }
                    });
                }
            });
        });
    });
</script>



{% endblock extra_js %}